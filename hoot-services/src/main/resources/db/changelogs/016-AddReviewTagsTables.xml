<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext"
	xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-2.0.xsd
    http://www.liquibase.org/xml/ns/dbchangelog-ext http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-ext.xsd">
	<changeSet author="jong.choi" id="16" context="default">
		<comment>
			review tags table to share/publish user specified review items
		</comment>
		<!-- review tags table -->
        <createTable tableName="review_tags">
            <column name="id" type="bigserial" autoIncrement="true">
            	<constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="map_id" type="bigint">
            	<constraints nullable="false"/>
            </column>
			<column name="relation_id" type="bigint">
            	<constraints nullable="false"/>
            </column>
			<column name="detail" type="hstore">
            	<constraints nullable="true"/>
            </column>
            
			<!-- See the modifySql command at the end for the "WITHOUT TIME ZONE" bit -->
            <column name="created_at" type="timestamp">
            	<constraints nullable="false"/>
            </column>
			<column name="last_modified_at" type="timestamp">
            	<constraints nullable="true"/>
            </column>
			<column name="created_by" type="bigint">
            	<constraints nullable="false"/>
            </column>
			<column name="last_modified_by" type="bigint">
            	<constraints nullable="false"/>
            </column>
            
        </createTable>
        <addForeignKeyConstraint 
        	constraintName="review_tags_map_id_fkey" 
        	baseTableName="review_tags" 
        	baseColumnNames="map_id" 
        	referencedTableName="maps" 
        	referencedColumnNames="id"/>
		<addForeignKeyConstraint 
        	constraintName="review_tags_relation_id_fkey" 
        	baseTableName="review_tags" 
        	baseColumnNames="relation_id" 
        	referencedTableName="current_relations" 
        	referencedColumnNames="id"/>
		<addForeignKeyConstraint 
        	constraintName="review_tags_created_by_id_fkey" 
        	baseTableName="review_tags" 
        	baseColumnNames="created_by" 
        	referencedTableName="users" 
        	referencedColumnNames="id"/>
		<addForeignKeyConstraint 
        	constraintName="review_tags_last_modified_by_id_fkey" 
        	baseTableName="review_tags" 
        	baseColumnNames="last_modified_by" 
        	referencedTableName="users" 
        	referencedColumnNames="id"/>
       	<createIndex tableName="review_tags" indexName="review_tags_map_id_idx">
       		<column name="map_id"></column>
       	</createIndex>
		<createIndex tableName="review_tags" indexName="review_tags_relation_id_idx">
       		<column name="relation_id"></column>
       	</createIndex>


		<!-- review tag notes table -->
        <createTable tableName="review_tag_notes">
            <column name="id" type="bigserial" autoIncrement="true">
            	<constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="tag_id" type="bigint">
            	<constraints nullable="false"/>
            </column>
			<column name="note" type="hstore">
            	<constraints nullable="false"/>
            </column>
            
			<!-- See the modifySql command at the end for the "WITHOUT TIME ZONE" bit -->
            <column name="created_at" type="timestamp">
            	<constraints nullable="false"/>
            </column>
			<column name="last_modified_at" type="timestamp">
            	<constraints nullable="true"/>
            </column>
			<column name="created_by" type="bigint">
            	<constraints nullable="false"/>
            </column>
			<column name="last_modified_by" type="bigint">
            	<constraints nullable="false"/>
            </column>
            
        </createTable>
        <addForeignKeyConstraint 
        	constraintName="review_tag_notes_tag_id_fkey" 
        	baseTableName="review_tag_notes" 
        	baseColumnNames="tag_id" 
        	referencedTableName="review_tags" 
        	referencedColumnNames="id"/>		
       	<createIndex tableName="review_tag_notes" indexName="review_tag_notes_tag_id_idx">
       		<column name="tag_id"></column>
       	</createIndex>

		<!-- There isn't an obvious way to specify without time zone in liquibase -->
		<modifySql dbms="postgresql">
			<replace replace="WITH TIME ZONE" with="WITHOUT TIME ZONE"/>
		</modifySql>
	</changeSet>
</databaseChangeLog>
