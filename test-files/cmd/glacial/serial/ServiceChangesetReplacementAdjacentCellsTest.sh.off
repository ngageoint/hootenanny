#!/bin/bash
set -e

# This tests the replacement effects at the replacement boundary when replacing data in adjacent task grids.

source conf/database/DatabaseConfig.sh
export OSM_API_DB_URL="osmapidb://$DB_USER:$DB_PASSWORD@$DB_HOST:$DB_PORT/$DB_NAME_OSMAPI"
export PSQL_DB_AUTH="-h $DB_HOST -p $DB_PORT -U $DB_USER"
export PGPASSWORD=$DB_PASSWORD_OSMAPI
HOOT_DB_URL="hootapidb://$DB_USER:$DB_PASSWORD@$DB_HOST:$DB_PORT/$DB_NAME"
REF_DB_INPUT=$OSM_API_DB_URL
SEC_DB_INPUT="$HOOT_DB_URL/ServiceChangesetReplacementAdjacentCellsTest-sec"
HOOT_EMAIL="ServiceChangesetReplacementAdjacentCellsTest@hoottestcpp.org"

CROP_AOI="" # leave empty to avoid cropping
# 4183
#CROP_AOI="-115.1083193,36.0045951,-115.0225009,36.0811562" # leave empty to avoid cropping
LOG_LEVEL="--status"
GENERAL_OPTS="-C UnifyingAlgorithm.conf -C Testing.conf -D uuid.helper.repeatable=true -D writer.include.debug.tags=true -D reader.add.source.datetime=false -D writer.include.circular.error.tags=false -D convert.bounding.box.remove.missing.elements=false -D log.warnings.for.missing.elements=false -D debug.maps.write=false -D debug.maps.remove.missing.elements=true -D log.class.filter= "
DB_OPTS="-D api.db.email=$HOOT_EMAIL -D hootapi.db.writer.create.user=true -D hootapi.db.writer.overwrite.map=true -D changeset.user.id=1 -D changeset.max.size=999999"

# 4182
#SOURCE_FILE_1="/home/vagrant/hoot/tmp/4182/329_ReferenceNOMEData_31JULY2020.osm"
#SOURCE_FILE_2="/home/vagrant/hoot/tmp/4182/329_SecondaryOSMData_31JULY2020.osm"
# 4183
SOURCE_FILE_1="/home/vagrant/hoot/tmp/4183/NOME_ReferenceData.osm"
SOURCE_FILE_2="/home/vagrant/hoot/tmp/4183/OSM_SecondaryData.osm"
#SOURCE_FILE_CROP_1="/home/vagrant/hoot/tmp/4183/NOME_ReferenceData-cropped.osm"
#SOURCE_FILE_CROP_2="/home/vagrant/hoot/tmp/4183/OSM_SecondaryData-cropped.osm"
#SOURCE_FILE_1="/home/vagrant/hoot/tmp/4183/NOME_ReferenceData-cropped.osm"
#SOURCE_FILE_2="/home/vagrant/hoot/tmp/4183/OSM_SecondaryData-cropped.osm"

if [[ "$CROP_AOI" == "" ]]; then
  echo ""
  echo "No cropping being performed on inputs..."
  echo ""
else
  echo ""
  echo "Cropping the reference dataset from: $SOURCE_FILE_1 at bounds: $CROP_AOI..."
  echo ""
  hoot crop $LOG_LEVEL $GENERAL_OPTS -D debug.maps.filename=$OUT_DIR/data-crop-ref-db.osm -D reader.use.data.source.ids=true -D map.reader.add.child.refs.when.missing=false $SOURCE_FILE_1 $SOURCE_FILE_CROP_1 $CROP_AOI
  SOURCE_FILE_1=$SOURCE_FILE_CROP_1
  echo ""
  echo "Cropping the secondary dataset from: $SOURCE_FILE_2 at bounds: $CROP_AOI..."
  echo ""
  hoot crop $LOG_LEVEL $GENERAL_OPTS -D debug.maps.filename=$OUT_DIR/data-crop-ref-db.osm -D reader.use.data.source.ids=true -D map.reader.add.child.refs.when.missing=false $SOURCE_FILE_2 $SOURCE_FILE_CROP_2 $CROP_AOI
  SOURCE_FILE_2=$SOURCE_FILE_CROP_2
fi

scripts/database/CleanAndInitializeOsmApiDb.sh

echo ""
echo "Writing reference dataset from: $SOURCE_FILE_1 to an osm api db (contains features to be replaced)..."
echo ""
hoot convert $LOG_LEVEL $GENERAL_OPTS $DB_OPTS -D debug.maps.filename=$OUT_DIR/data-prep-ref-db.osm -D reader.use.data.source.ids=true $SOURCE_FILE_1 $REF_DB_INPUT 

echo ""
echo "Writing the secondary dataset from: $SOURCE_FILE_2 to a hoot api db (contains features to replace with)..."
echo ""
hoot convert $LOG_LEVEL $GENERAL_OPTS $DB_OPTS -D debug.maps.filename=$OUT_DIR/data-prep-sec-db.osm -D reader.use.data.source.ids=true $SOURCE_FILE_2 $SEC_DB_INPUT

# TASK 1

TEST_NAME="ServiceChangesetReplacementAdjacentCellsTest-task1"

IN_DIR=test-files/cmd/glacial/serial/$TEST_NAME
OUT_DIR=test-output/cmd/glacial/serial/$TEST_NAME
rm -rf $OUT_DIR
mkdir -p $OUT_DIR

CHANGESET_DERIVE_OPTS="-D changeset.user.id=1 -D bounds.output.file=$OUT_DIR/$TEST_NAME-bounds.osm -D snap.unconnected.ways.existing.way.node.tolerance=5.0 -D snap.unconnected.ways.snap.tolerance=0.5"
CHANGESET_DB=$OUT_DIR/$TEST_NAME-changeset-db.osc.sql
CHANGESET_DB_DEBUG=$OUT_DIR/$TEST_NAME-changeset-db.osc
OUT_DB=$TEST_NAME-db-replaced.osm

# southern task 14 - 4182
REPLACEMENT_AOI="-119.750977,39.0447859,-119.7399904,39.0533182"
# 4183
#REPLACEMENT_AOI="-115.0927735,36.0313319,-115.0488281,36.0668621"

echo ""
echo "Deriving a changeset between the osm api db and the hoot api db layers over: $REPLACEMENT_AOI, to file: $CHANGESET_DB that replaces features in the reference dataset with those from a secondary dataset..."
echo ""
hoot changeset-derive-replacement $LOG_LEVEL $GENERAL_OPTS $DB_OPTS $CHANGESET_DERIVE_OPTS -D debug.maps.filename=$OUT_DIR/changeset-derive-db.osm $REF_DB_INPUT $SEC_DB_INPUT $REPLACEMENT_AOI $CHANGESET_DB $REF_DB_INPUT --full-replacement --write-bounds --disable-conflation --disable-cleaning

echo ""
echo "Applying the changeset: $CHANGESET_DB to the reference data in the osm api db..."
echo ""
hoot changeset-apply $LOG_LEVEL $GENERAL_OPTS $DB_OPTS $CHANGESET_DERIVE_OPTS -D debug.maps.filename=$OUT_DIR/changeset-apply-db.osm $CHANGESET_DB $OSM_API_DB_URL

echo ""
echo "Reading the entire reference dataset out of the osm api db to: $OUT_DB for verification..."
echo ""
hoot convert $LOG_LEVEL $GENERAL_OPTS $DB_OPTS -D debug.maps.filename=$OUT_DIR/final-write-db.osm $OSM_API_DB_URL $OUT_DIR/$OUT_DB

# for replacing a single cell
#exit

# TASK 2

TEST_NAME="ServiceChangesetReplacementAdjacentCellsTest-task2"

IN_DIR=test-files/cmd/glacial/serial/$TEST_NAME
OUT_DIR=test-output/cmd/glacial/serial/$TEST_NAME
rm -rf $OUT_DIR
mkdir -p $OUT_DIR

CHANGESET_DERIVE_OPTS="-D changeset.user.id=1 -D bounds.output.file=$OUT_DIR/$TEST_NAME-bounds.osm -D snap.unconnected.ways.existing.way.node.tolerance=5.0 -D snap.unconnected.ways.snap.tolerance=0.5"
CHANGESET_DB=$OUT_DIR/$TEST_NAME-changeset-db.osc.sql
CHANGESET_DB_DEBUG=$OUT_DIR/$TEST_NAME-changeset-db.osc
OUT_DB=$TEST_NAME-db-replaced.osm

# northern task 15 - 4182
REPLACEMENT_AOI="-119.7509766,39.0533178,-119.7399902,39.0618491"

echo ""
echo "Deriving a changeset between the osm api db and the hoot api db layers over: $REPLACEMENT_AOI, to file: $CHANGESET_DB that replaces features in the reference dataset with those from a secondary dataset..."
echo ""
hoot changeset-derive-replacement $LOG_LEVEL $GENERAL_OPTS $DB_OPTS $CHANGESET_DERIVE_OPTS -D debug.maps.filename=$OUT_DIR/changeset-derive-db.osm $REF_DB_INPUT $SEC_DB_INPUT $REPLACEMENT_AOI $CHANGESET_DB $REF_DB_INPUT --full-replacement --write-bounds --disable-conflation --disable-cleaning

echo ""
echo "Applying the changeset: $CHANGESET_DB to the reference data in the osm api db..."
echo ""
hoot changeset-apply $LOG_LEVEL $GENERAL_OPTS $DB_OPTS $CHANGESET_DERIVE_OPTS -D debug.maps.filename=$OUT_DIR/changeset-apply-db.osm $CHANGESET_DB $OSM_API_DB_URL

echo ""
echo "Reading the entire reference dataset out of the osm api db to: $OUT_DB for verification..."
echo ""
hoot convert $LOG_LEVEL $GENERAL_OPTS $DB_OPTS -D debug.maps.filename=$OUT_DIR/final-write-db.osm $OSM_API_DB_URL $OUT_DIR/$OUT_DB

echo ""
echo "Removing data from secondary input..."
echo ""
hoot db-delete-map $LOG_LEVEL $GENERAL_OPTS $DB_OPTS -D debug.maps.filename=$OUT_DIR/cleanup-db.osm $SEC_DB_INPUT

# Delete the user
PGPASSWORD=$DB_PASSWORD psql $PSQL_DB_AUTH -c "DELETE FROM users WHERE email='$HOOT_EMAIL';" > /dev/null
